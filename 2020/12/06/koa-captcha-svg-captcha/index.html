<!DOCTYPE html>

<html lang="en">
  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
  <title>Implementing SVG Captcha in Koa — tao&#39;s blog</title>
  <meta name="description" content="Tech Blog">
  
  <meta name="keywords" content="nodejs c# js ts python">
  
  <link rel="canonical" href="https://taotao7.top/2020/12/06/koa-captcha-svg-captcha/index.html">
  
  <link rel="alternate" type="application/atom+xml" title="tao&#39;s blog" href="/atom.xml">
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Audiowide&family=Metamorphous&family=Space+Grotesk:wght@300..700&display=swap" rel="stylesheet">
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 5.4.2"></head>

  <body>
    <header class="header" id="header">
  <div class="container header__inner">
    <a class="header__logo" href="/" aria-label="tao&#39;s blog">
      tao&#39;s blog
    </a>
    
    <button class="header__toggle" id="nav-toggle" aria-label="Toggle navigation">
      <span></span><span></span><span></span>
    </button>
    <nav class="header__nav" id="nav-menu">
      
        <a class="header__link" href="/">Home</a>
      
        <a class="header__link" href="/archives/">Archives</a>
      
        <a class="header__link" href="/tags/">Tags</a>
      
        <a class="header__link" href="/project/">Project</a>
      
        <a class="header__link" href="/about/">About</a>
      
        <a class="header__link" target="_blank" rel="noopener" href="https://github.com/taotao7">GitHub</a>
      
      
        <a class="header__link header__link--rss" href="/atom.xml" aria-label="RSS">RSS</a>
      
      <button
        class="header__link header__link--lang"
        id="lang-switch"
        type="button"
        aria-label="Switch language"
        data-default-lang="en"
        data-current-lang="en"
        data-other-lang="zh-CN"
      >中文</button>
    </nav>
  </div>
</header>

    <main class="main">
      <div class="container"><article class="post">
  <header class="post__header">
    <h1 class="post__title">Implementing SVG Captcha in Koa</h1>
    <div class="post__meta">
      <time datetime="2020-12-06">2020-12-06</time>
      
        <span class="post__sep">&middot;</span>
        
        <span class="post__reading-time">3 min read</span>
      
      
    </div>
    
    <div class="post__tags">
      
        <a class="tag-pill" href="/tags/Node-js/">Node.js</a>
      
        <a class="tag-pill" href="/tags/Koa/">Koa</a>
      
        <a class="tag-pill" href="/tags/Captcha/">Captcha</a>
      
    </div>
    
  </header>

  <div class="post__layout">
    
<aside class="toc-wrap" id="toc-wrap">
  <button class="toc-toggle" id="toc-toggle" aria-label="Toggle table of contents">Contents</button>
  <nav class="toc" id="toc">
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Koa-Captcha"><span class="toc-text">Koa Captcha</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Session-Configuration"><span class="toc-text">Session Configuration</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Verification"><span class="toc-text">Verification</span></a></li></ol>
  </nav>
</aside>


    <div class="post__content" id="post-content">
      <h1 id="Koa-Captcha"><a href="#Koa-Captcha" class="headerlink" title="Koa Captcha"></a>Koa Captcha</h1><p>First, install <code>svg-captcha</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">npm install svg-captcha --save<br></code></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> svgCaptcha = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;svg-captcha&quot;</span>);<br></code></pre></td></tr></table></figure>

<p>Create an endpoint to serve the captcha:</p>
<p><img src="1.png" alt="Interface"></p>
<p><strong>Key Points:</strong></p>
<ul>
<li><strong>Case Sensitivity</strong>: Always use <code>toLowerCase()</code> when storing/comparing the text, otherwise validation will fail unexpectedly.</li>
<li><strong>Session</strong>: You need <code>koa-session</code> to store the correct captcha text (<code>ctx.session.captcha</code>) for later verification.</li>
<li><strong>Content-Type</strong>: Set the header to <code>image/svg+xml</code> so the browser renders it as an image.</li>
</ul>
<h1 id="Session-Configuration"><a href="#Session-Configuration" class="headerlink" title="Session Configuration"></a>Session Configuration</h1><p>You need to configure <code>koa-session</code> for this to work:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">KoaSession</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;koa-session&quot;</span>);<br><span class="hljs-keyword">const</span> sessionConfig = &#123;<br>  <span class="hljs-attr">key</span>: <span class="hljs-string">&quot;appletSystem:sess&quot;</span>,<br>  <span class="hljs-attr">maxAge</span>: <span class="hljs-number">3000</span> * <span class="hljs-number">60</span>, <span class="hljs-comment">// 3 minutes</span><br>  <span class="hljs-attr">autoCommit</span>: <span class="hljs-literal">true</span>,<br>  <span class="hljs-attr">overwrite</span>: <span class="hljs-literal">true</span>,<br>  <span class="hljs-attr">httpOnly</span>: <span class="hljs-literal">true</span>,<br>  <span class="hljs-attr">signed</span>: <span class="hljs-literal">true</span>,<br>  <span class="hljs-attr">rolling</span>: <span class="hljs-literal">true</span>,<br>  <span class="hljs-attr">renew</span>: <span class="hljs-literal">true</span>,<br>&#125;;<br><span class="hljs-keyword">const</span> sessionSignedKey = [<span class="hljs-string">&quot;appletSystem&quot;</span>]; <span class="hljs-comment">// Secret key</span><br><span class="hljs-keyword">const</span> session = <span class="hljs-keyword">new</span> <span class="hljs-title class_">KoaSession</span>(sessionConfig, app);<br>app.<span class="hljs-property">keys</span> = sessionSignedKey;<br>app.<span class="hljs-title function_">use</span>(session);<br></code></pre></td></tr></table></figure>

<h1 id="Verification"><a href="#Verification" class="headerlink" title="Verification"></a>Verification</h1><p>When the frontend requests <code>/captcha</code>, the server generates the image and stores the text in the session (encrypted/signed in the cookie).</p>
<p>When the user submits the form with the captcha code, you simply compare the submitted value with <code>ctx.session.captcha</code>.</p>

    </div>
  </div>

  <footer class="post__footer">
    
    <div class="post__copyright">
      <p>Author: tao</p>
      <p>Link: <a href="https://taotao7.top/2020/12/06/koa-captcha-svg-captcha/">https://taotao7.top/2020/12/06/koa-captcha-svg-captcha/</a></p>
      <p>License: <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a></p>
    </div>
    

    
    <nav class="post-nav">
      
      <a class="post-nav__link post-nav__prev" href="/2020/12/06/hexo-seo-optimization/">
        <span class="post-nav__label">&larr; Previous</span>
        <span class="post-nav__title">Hexo SEO Optimization for Baidu and Google</span>
      </a>
      
      
      <a class="post-nav__link post-nav__next" href="/2020/12/05/new-blog/">
        <span class="post-nav__label">Next &rarr;</span>
        <span class="post-nav__title">New Blog</span>
      </a>
      
    </nav>
    
  </footer>
</article>
</div>
    </main>
    <footer class="footer">
  <div class="container footer__inner">
    <div class="footer__left">
      <span>&copy; 2026 tao</span>
      <span class="footer__sep">&middot;</span>
      <span>Powered by <a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a></span>
    </div>
    <div class="footer__right">
      
        
        
        
      
    </div>
  </div>
</footer>
 
<script src="/js/main.js"></script>


  <script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"display":null,"superSample":2,"width":150,"height":300,"position":"right","hOffset":0,"vOffset":-20,"jsonPath":"/live2dw/assets/assets/wanko.model.json"},"mobile":{"show":true},"react":{"opacity":0.7},"log":false});</script></body>
</html>
